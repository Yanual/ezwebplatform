#!/bin/bash

if [ $(id -u) != 0 ]; then
  echo $0: You must run this as root.
  exit 1
fi

SAVE=false
OPTIONS=$(getopt -ao "" --longoptions "server-type:,connection-type:,database-engine:" -n "$0" -- "$@")
eval set -- $OPTIONS

usage="$0 [options] conf_name"

USER_SERVER_TYPE="USER_SERVER_TYPE"
USER_CONNECTION_TYPE="USER_CONNECTION_TYPE"
USER_DATABASE_ENGINE="USER_DATABASE_ENGINE"

###
# Parse options
#
while true; do
  case "$1" in
  --server-type)
    SAVE=true
    USER_SERVER_TYPE="$2"
    shift 2
    ;;
  --connection-type)
    SAVE=true
    USER_CONNECTION_TYPE="$2"
    shift 2
    ;;
  --database-engine)
    SAVE=true
    USER_DATABASE_ENGINE="$2"
    shift 2
    ;;
  --)
    shift
    break
    ;;
  *)
    echo $usage;
    exit 1;
    ;;
  esac
done

###
# Get CONF_NAME
#
if [ ! $# -eq 1 ]; then
  echo $usage
  exit -1;
fi

CONF_NAME=$1

###
# Load config if it exists
#
if [ -f /etc/ezweb-platform/sites/$CONF_NAME/config ]; then
  . /etc/ezweb-platform/sites/$CONF_NAME/config
fi

###
# Update config
#
if [ "$USER_SERVER_TYPE" != "USER_SERVER_TYPE" ]; then
  SERVER_TYPE="$USER_SERVER_TYPE"
fi

if [ "$USER_CONNECTION_TYPE" != "USER_CONNECTION_TYPE" ]; then
  CONNECTION_TYPE="$USER_CONNECTION_TYPE"
fi

if [ "$USER_DATABASE_ENGINE" != "USER_DATABASE_ENGINE" ]; then
  DATABASE_ENGINE="$USER_DATABASE_ENGINE"
fi

if [ "$SERVER_NAME" = "" ]; then
  SERVER_NAME="localhost"
fi

###
# Check server type
#
if [ ! -x /usr/sbin/update-ezweb-platform-$SERVER_TYPE ]; then
  echo "Unknown server type \"$SERVER_TYPE\". May be you need to install other ezweb-platform packages."
  exit -1
fi

export SERVER_TYPE CONNECTION_TYPE DATABASE_ENGINE DATABASE_NAME DATABASE_USER DATABASE_PASS DATABASE_HOST DATABASE_PORT
echo -n "Checking server settings (using $SERVER_TYPE as server)... "
/usr/sbin/update-ezweb-platform-$SERVER_TYPE --dry-run $CONF_NAME
if [ $? != 0 ]; then
  echo "Error";
  exit -1;
fi
echo "Done"

###
# Check database settins
#
echo "Checking database settings (using $DATABASE_ENGINE as DBMS)... "
RET=`/usr/sbin/update-ezweb-platform-$DATABASE_ENGINE prepare $CONF_NAME`
if [ $? != 0 ]; then
  echo "Error";
  exit -1;
fi
eval $RET
echo "Done"

###
# Save new config if needed (creation & update)
#
if [ $SAVE = true ]; then
  echo -n "Saving configuration for \"$CONF_NAME\"..."
  mkdir -p /etc/ezweb-platform/sites/$CONF_NAME
  echo \
"#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by $0

SERVER_TYPE=$SERVER_TYPE
CONNECTION_TYPE=$CONNECTION_TYPE
SERVER_NAME=$SERVER_NAME

DATABASE_ENGINE=$DATABASE_ENGINE
DATABASE_NAME=$DATABASE_NAME
DATABASE_USER=$DATABASE_USER
DATABASE_PASS=$DATABASE_PASS
DATABASE_HOST=$DATABASE_HOST
DATABASE_PORT=$DATABASE_PORT" \
  > /etc/ezweb-platform/sites/$CONF_NAME/config
  echo "Done"
fi

echo -n "Updating server settings (using $SERVER_TYPE as server)... "
/usr/sbin/update-ezweb-platform-$SERVER_TYPE $CONF_NAME
if [ $? != 0 ]; then
  echo "Error"
  exit -1
fi
echo "Done"

echo -n "Updating EzWeb settings... "
sed -e "s/@DATABASE_ENGINE@/$DJANGO_DATABASE_ENGINE/g" \
    -e "s/@DATABASE_NAME@/$DATABASE_NAME/g" \
    -e "s/@DATABASE_OPTIONS@/$DATABASE_OPTIONS/g" \
    -e "s/@DATABASE_USER@/$DATABASE_USER/g" \
    -e "s/@DATABASE_PASS@/$DATABASE_PASS/g" \
    -e "s/@DATABASE_HOST@/$DATABASE_HOST/g" \
    -e "s/@DATABASE_PORT@/$DATABASE_PORT/g" \
    < /etc/ezweb-platform/settings.py-template > /etc/ezweb-platform/sites/$CONF_NAME/settings.py
echo "Done"

echo -n "Synchronising database... "
export PYTHONPATH="/etc/ezweb-platform/sites/$CONF_NAME:/usr/share/ezweb-platform"
export DJANGO_SETTINGS_MODULE=settings
django-admin syncdb
echo "Done"

echo "EzWeb site \"$CONF_NAME\" updated sucessfully."
echo "Restart your $SERVER_TYPE to enable changes"